// src/controllers/CheckCpfsLista.js
require('dotenv').config();

const fs = require('fs');
const path = require('path');
const axios = require('axios');

function log(msg) {
  console.log('[CPF_CHECK]', msg);
}

function onlyDigits(v) {
  return (v || '').toString().replace(/\D/g, '');
}

function buildFilePath() {
  const now = new Date();
  const year = String(now.getFullYear());
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const time =
    String(now.getHours()).padStart(2, '0') +
    String(now.getMinutes()).padStart(2, '0') +
    String(now.getSeconds()).padStart(2, '0');

  const dir = path.join(
    __dirname,
    '..',
    '..',
    'logs',
    'odonto',
    'check_cpfs',
    year,
    month,
    day
  );
  fs.mkdirSync(dir, { recursive: true });

  return path.join(dir, `${time}_cpfs_check.txt`);
}

async function consultarAssociadoEmp(cpf, tokenApiv3, baseApiV3) {
  const empresasParam = '[27543, 27552]';
  const url = `${baseApiV3}/associado-Emp?cpf=${cpf}&empresas=${encodeURIComponent(
    empresasParam
  )}`;

  log(`[CPF_CHECK] GET associado-Emp: ${url}`);

  try {
    const resp = await axios.get(url, {
      headers: {
        Authorization: `Bearer ${tokenApiv3}`,
      },
      timeout: 30000,
    });

    const data = resp.data;
    const arr = Array.isArray(data) ? data : [];
    const found = arr.length > 0;

    return {
      statusApi: found ? 'ENCONTRADO' : 'NAO_ENCONTRADO',
      httpStatus: resp.status,
      msg: found
        ? `Encontrado(s) ${arr.length} registro(s) na API`
        : 'Nenhum registro encontrado na API',
    };
  } catch (err) {
    const httpStatus = err.response?.status || 'no-response';
    return {
      statusApi: 'ERRO',
      httpStatus,
      msg: err.message || 'Erro ao chamar API',
    };
  }
}

// ================== LISTA DE CPFs ==================

const CPFS = [
  '72301473953',
  '78880327968',
  '54965381904',
  '12359463985',
  '72510137972',
  '03585738907',
  '10823829901',
  '14903545903',
  '15028557985',
  '09696512953',
  '08018161909',
  '83083480091',
  '00456757082',
  '13363894945',
  '15516634903',
  '13030029905',
  '36553972915',
  '05353831934',
  '08599375938',
  '07866804907',
  '04474953991',
  '10662152948',
  '05371967907',
  '03505947911',
  '13239161990',
  '05844218930',
  '09032776975',
  '08069182920',
  '07615686113',
  '06521629913',
  '13240184966',
  '07755469921',
  '11131075960',
  '14051712940',
  '08742376963',
  '03040010905',
  '55540726820',
  '09876610945',
  '06846753907',
  '08505944992',
  '11227151969',
  '10664082700',
  '06015023961',
  '12633273971',
  '07443553978',
  '06979821903',
  '11766525911',
  '13190170967',
  '09880299957',
  '05847677901',
  '91700680978',
  '51769060820',
  '10981297927',
  '08796281979',
  '00985049910',
  '09064018952',
  '09680079961',
  '06590729980',
  '32271168805',
  '45627931809',
  '13084297975',
  '02931640964',
  '12856760929',
  '00113881967',
  '03958499937',
  '12365373941',
  '13004132982',
  '08524141964',
  '80079594913',
  '40037664824',
  '04712320923',
  '11719169900',
  '16049657971',
  '01369243952',
  '12088894942',
  '06488196987',
  '03365465219',
  '14100952902',
  '12596821966',
  '13848067927',
  '09322764902',
  '06382831913',
  '12417331985',
  '13812621983',
  '11794374973',
  '13829895984',
  '07983492987',
  '13046429924',
  '14249351998',
  '12544726903',
  '11943229139',
  '11943230145',
  '00162308922',
  '03949161902',
  '13561039952',
  '09851806927',
  '11329788907',
  '14844259954',
  '12570934950',
  '12800454938',
  '71201110270',
  '16038376984',
  '13097434950',
  '14729193946',
  '15970683493',
  '15052878982',
  '06888558908',
  '02850403911',
  '01636760970',
  '05402562938',
  '04990614976',
  '14272461907',
  '90383460930',
  '10629970939',
  '11140833995',
  '07559394175',
  '05315148971',
  '09852544918',
  '09801755938',
  '09635719906',
  '08474779910',
  '10166805971',
  '11025862937',
  '15846254497',
  '40850203821',
  '12955133906',
  '06746821900',
  '11686865988',
  '08521809930',
  '08127282464',
  '25375051826',
  '04562075970',
  '07950515902',
  '10324278926',
  '04183565995',
  '09258217993',
  '05868545923',
  '05202917945',
  '06940204865',
  '74911732920',
  '03632977909',
  '14071014989',
  '14071046910',
  '04359353995',
  '14107557979',
  '15099818960',
  '11971544930',
  '00109019903',
  '15869455995',
  '15869450926',
  '10690428979',
  '05994769908',
  '60291123090',
  '06605862902',
  '13890243932',
  '09961967909',
  '06596444953',
  '15817153904',
  '03761294921',
  '14478312923',
  '16284058993',
  '04838505949',
  '08723235950',
  '12193304939',
  '05102404962',
  '11404848932',
  '13618941994',
  '08939420900',
  '03624702947',
  '05538388905',
  '13498005979',
  '13889376975',
  '08668698915',
  '66435161534',
  '11791026907',
  '15823579942',
  '12188857933',
  '58450957869',
  '09016452907',
  '15528061970',
  '15283881946',
  '09867421981',
  '56391978972',
  '02013639929',
  '80068095937',
  '11911373927',
  '10301807922',
  '09472733956',
  '12150265958',
  '01811443958',
  '14691724966',
  '14691717919',
  '13925362940',
  '03791081942',
  '12194673911',
  '12195026936',
  '11497187907',
  '02599333920',
  '04742414918',
  '03697320904',
  '07044275915',
  '04703990903',
  '72632399904',
  '96472979987',
  '11625474644',
  '79369863249',
  '07629270208',
  '04876201943',
  '09327379942',
  '14881135996',
  '83278249968',
  '00120671999',
  '08576300915',
  '41315053802',
  '15920940905',
  '11596991941',
  '12086013930',
  '00893623903',
  '10748746927',
  '00114805997',
  '00710966989',
  '09080968951',
  '35874019855',
  '11236065956',
  '13785839901',
  '05682085957',
  '12719489905',
  '04201835901',
  '07845732982',
  '09456219909',
  '07236467910',
  '07751452978',
  '16109079901',
  '08251054982',
  '00297170945',
  '04337784900',
  '02125499959',
  '11907680977',
  '01293933805',
  '06316304900',
  '10259274941',
  '16051213988',
  '11662765975',
  '09647966946',
  '16558576902',
  '03761271980',
  '14043230907',
  '07822142909',
  '16576431902',
  '10822539950',
  '13356924958',
  '10755464940',
  '07877197900',
  '05050743974',
  '05624299990',
  '14866738995',
  '14866698918',
  '13959584911',
  '08962430959',
  '07509391920',
  '12571845985',
  '11794336966',
  '09030956968',
  '09663861916',
  '10931771951',
  '12547950901',
  '10042691966',
  '11715555988',
  '85508454004',
  '14673326903',
  '08245097900',
  '11231243961',
  '23884206877',
  '08218637974',
  '07569715942',
  '10351513914',
  '12426832916',
  '07298441965',
  '15518482957',
  '10159664977',
  '10748149910',
  '09480521989',
  '07515961910',
  '04406473980',
  '13883467960',
  '09920128996',
  '46615038803',
  '10878827960',
  '11295288982',
  '07259669985',
  '00121477967',
  '14716825957',
  '05148468955',
  '11585761966',
  '06749735932',
  '09022162958',
  '08773221988',
  '11333828942',
  '11785305905',
  '08855676920',
  '08856362953',
  '56938241953',
  '68545703449',
  '02106177992',
  '16112207931',
  '00324513933',
  '09984849970',
  '08866376949',
  '07168441922',
  '03115088981',
  '14274778924',
  '03067151984',
  '08479374969',
  '11599319926',
  '16675874985',
  '01526758920',
  '61979546991',
  '50554980991',
  '10431924929',
  '12092530976',
  '13089444976',
  '04151297960',
  '05970776904',
  '08602586965',
  '16496805970',
  '12218980940',
  '10510248977',
  '07570414934',
  '10227310926',
  '15476535900',
  '09828575949',
  '10660111926',
  '05901576985',
  '03770148932',
  '05413146965',
  '06043936950',
  '11909341916',
  '10920247946',
  '10252476980',
  '15427989900',
  '07902544922',
  '08539726998',
  '15636924909',
  '00328604984',
  '11203810962',
  '03563115974',
  '49446614953',
  '10773219960',
  '12068455978',
  '09088723990',
  '05802643943',
  '80090336933',
  '09149137948',
  '10671462962',
  '06427172905',
  '08523407960',
  '15174841978',
  '09874408960',
  '08477906904',
  '12651140996',
  '15562455994',
  '09396940933',
  '10937877913',
  '61506222900',
  '86348647315',
  '18144285778',
  '04347979959',
  '04846820912',
  '13468498977',
  '13651231976',
  '33929016877',
  '11473164907',
  '03549151934',
  '06532063991',
  '13760669719',
  '06639359979',
  '13709443903',
  '05331423930',
  '08729786991',
  '08047718983',
  '05176077949',
  '70275646106',
  '01236397940',
  '80131011936',
  '11796909904',
  '11716858909',
  '13180115904',
  '07959599904',
  '11178648982',
  '05738452984',
  '04745333951',
  '12038217947',
  '05405360910',
  '09157904910',
  '11684434904',
];

// ================== MAIN ==================

async function main() {
  try {
    const baseApiV3 = process.env.ODONTO_BASE_APIV3; // ex: https://apiv3.odontogroup.com.br/api
    const tokenApiv3 = process.env.ODONTO_APIV3_TOKEN;

    if (!baseApiV3 || !tokenApiv3) {
      throw new Error(
        'Configure ODONTO_BASE_APIV3 e ODONTO_APIV3_TOKEN no .env antes de rodar.'
      );
    }

    const filePath = buildFilePath();
    log(`Arquivo de sa√≠da: ${filePath}`);

    const stream = fs.createWriteStream(filePath, { encoding: 'utf8' });
    stream.write('CPF;STATUS_API;HTTP_STATUS;MENSAGEM\n');

    for (const rawCpf of CPFS) {
      const cpf = onlyDigits(rawCpf);
      if (!cpf) continue;

      const result = await consultarAssociadoEmp(cpf, tokenApiv3, baseApiV3);

      const line = [
        cpf,
        result.statusApi,
        result.httpStatus,
        (result.msg || '').replace(/[\r\n;]+/g, ' '),
      ].join(';');

      stream.write(line + '\n');
    }

    stream.end();
    log('Finalizado. Confira o arquivo TXT gerado.');
  } catch (err) {
    console.error('[CPF_CHECK] Erro geral:', err.message || err);
  }
}

if (require.main === module) {
  main();
}

module.exports = { main };
